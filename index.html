<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœå–®è¨ˆç®—æ©Ÿ (V5.4)</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #007bff;
            font-size: 24px;
        }
        /* èªéŸ³æŒ‰éˆ•æ¨£å¼å„ªåŒ– */
        #startButton {
            /* å¢å¤§æŒ‰éˆ•å°ºå¯¸ */
            padding: 15px 30px; 
            font-size: 22px; 
            width: 80%; /* è®“å®ƒåœ¨è¡Œå‹•è£ç½®ä¸Šæ›´çªå‡º */
            max-width: 300px; 
            margin-top: 20px;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            background-color: #ffc107;
            color: #333;
            /* å¢åŠ ç«‹é«”æ„Ÿ */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); 
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
        }
        #startButton:hover {
            background-color: #e0a800;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.25);
        }
        #startButton:active {
            transform: translateY(2px);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        /* èœå–®æŒ‰éˆ•æ¨£å¼ */
        .menu-button {
            padding: 10px 5px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s;
            text-align: center;
            line-height: 1.3;
        }
        .menu-button:hover {
            background-color: #d8dde3;
            transform: translateY(-1px);
        }
        .menu-button:active {
            background-color: #c9cfd6;
            transform: translateY(0);
        }
        .menu-button strong {
            display: block;
            font-size: 16px;
            color: #28a745;
        }
        /* ä¿®æ­£: è¨‚å–®ç´°é …å›ºå®šé«˜åº¦å®¹å™¨ */
        #orderSummaryContainer {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            border: 1px dashed #ccc;
            text-align: left;
            background-color: #fff;
            
            height: 180px; 
            overflow-y: auto; 
        }
        #summaryTitle {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        #summaryList {
            display: block;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #summaryList li {
            margin-bottom: 3px;
            padding-left: 10px;
        }
        #output {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            min-height: 30px;
            border: 1px dashed #ccc;
            text-align: left;
        }
        #result {
            font-size: 22px;
            font-weight: bold;
            color: #dc3545;
            background-color: #ffe0e6;
            padding: 10px;
            border-radius: 5px;
        }
        #status {
            margin-top: 10px;
            color: #007bff;
            font-style: italic;
        }
        #clearButton {
            background-color: #dc3545;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 10px;
            margin-bottom: 10px; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>èªéŸ³/é»æ“Š èœå–®è¨ˆç®—æ©Ÿ</h1>

    <div id="status">é»æ“ŠæŒ‰éˆ•ï¼Œé–‹å§‹èªªå‡ºæ‚¨çš„è¨‚å–®</div>
    <button id="startButton">ğŸ™ï¸ é–‹å§‹èªéŸ³è¼¸å…¥</button>
    
    <div id="output">è¾¨è­˜çµæœ: (èªéŸ³æ¨¡å¼è¼¸å…¥çš„æ–‡æœ¬)</div>
    
    <div id="orderSummaryContainer">
        <span id="summaryTitle">è¨‚å–®ç´°é …:</span>
        <ul id="summaryList">
            <li>ç„¡å“é …</li>
        </ul>
    </div>
    
    <button id="clearButton">æ¸…ç©ºè¨‚å–®</button>
    <div id="result">ç¸½é‡‘é¡: $0</div>

    <h2>èœå–®å“é … (é»æ“Šå³å¯åŠ å…¥)</h2>
    <div class="menu-grid">
        <button class="menu-button" data-item="è±¬è‚‰è›‹é¤…"><strong>è±¬è‚‰è›‹é¤…</strong>$70</button>
        <button class="menu-button" data-item="ç‰›è‚‰è›‹é¤…"><strong>ç‰›è‚‰è›‹é¤…</strong>$70</button>
        <button class="menu-button" data-item="è”¬èœè›‹é¤…"><strong>è”¬èœè›‹é¤…</strong>$45</button>
        <button class="menu-button" data-item="ç‰ç±³è›‹é¤…"><strong>ç‰ç±³è›‹é¤…</strong>$45</button>
        <button class="menu-button" data-item="è›‹é¤…"><strong>è›‹é¤…</strong>$35</button>
        <button class="menu-button" data-item="è±¬è‚‰é¤¡é¤…"><strong>è±¬è‚‰é¤¡é¤…</strong>$45</button>
        <button class="menu-button" data-item="ç‰›è‚‰é¤¡é¤…"><strong>ç‰›è‚‰é¤¡é¤…</strong>$45</button>
        <button class="menu-button" data-item="éŸ­èœé¤…"><strong>éŸ­èœé¤…</strong>$26</button>
        <button class="menu-button" data-item="è”¥é¤…"><strong>è”¥é¤…</strong>$26</button>
        <button class="menu-button" data-item="ç´…è±†é¤…"><strong>ç´…è±†é¤…</strong>$24</button>
        <button class="menu-button" data-item="èŠ‹é ­é¤…"><strong>èŠ‹é ­é¤…</strong>$24</button>
        <button class="menu-button" data-item="ç‡’é¤…"><strong>ç‡’é¤…</strong>$24</button>
        <button class="menu-button" data-item="æ²¹æ¢"><strong>æ²¹æ¢</strong>$22</button>
        <button class="menu-button" data-item="ç‡’é¤…æ²¹æ¢"><strong>ç‡’é¤…æ²¹æ¢</strong>$46</button>
        <button class="menu-button" data-item="ç‡’é¤…è‚‰ç‰‡"><strong>ç‡’é¤…è‚‰ç‰‡</strong>$55</button>
        <button class="menu-button" data-item="ç‡’é¤…è”¥è›‹"><strong>ç‡’é¤…è”¥è›‹</strong>$42</button>
        <button class="menu-button" data-item="ç‡’é¤…è·åŒ…è›‹"><strong>ç‡’é¤…è·åŒ…è›‹</strong>$39</button>
        <button class="menu-button" data-item="è”¥è›‹"><strong>è”¥è›‹</strong>$18</button>
        <button class="menu-button" data-item="è·åŒ…è›‹"><strong>è·åŒ…è›‹</strong>$15</button>
        <button class="menu-button" data-item="è±†æ¼¿"><strong>è±†æ¼¿</strong>$20</button>
        <button class="menu-button" data-item="ç´…èŒ¶"><strong>ç´…èŒ¶</strong>$20</button>
        <button class="menu-button" data-item="å¥¶èŒ¶"><strong>å¥¶èŒ¶</strong>$20</button>
        <button class="menu-button" data-item="é¹¹è±†æ¼¿"><strong>é¹¹è±†æ¼¿</strong>$30</button>
    </div>
</div>

<script>
    // èœå–®åƒ¹æ ¼ (ç¢ºä¿èˆ‡ HTML é¡¯ç¤ºçš„åƒ¹æ ¼ä¸€è‡´)
    const menu = {
        'è±¬è‚‰è›‹é¤…': 70, 'ç‰›è‚‰è›‹é¤…': 70, 'è”¬èœè›‹é¤…': 45, 'ç‰ç±³è›‹é¤…': 45, 'è›‹é¤…': 35,
        'è±¬è‚‰é¤¡é¤…': 45, 'ç‰›è‚‰é¤¡é¤…': 45, 'éŸ­èœé¤…': 26, 'è”¥é¤…': 26, 'ç´…è±†é¤…': 24, 
        'èŠ‹é ­é¤…': 24, 'ç‡’é¤…': 24, 'æ²¹æ¢': 22, 'ç‡’é¤…æ²¹æ¢': 46, 'ç‡’é¤…è‚‰ç‰‡': 55, 
        'ç‡’é¤…è”¥è›‹': 42, 'ç‡’é¤…è·åŒ…è›‹': 39, 'è”¥è›‹': 18, 'è·åŒ…è›‹': 15, 'è±†æ¼¿': 20,
        'ç´…èŒ¶': 20, 'å¥¶èŒ¶': 20, 'é¹¹è±†æ¼¿': 30
    };

    // å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜ç•¶å‰è¨‚å–® (é»æ“Šå’ŒèªéŸ³éƒ½æœƒä¿®æ”¹å®ƒ)
    let currentOrder = {};

    const startButton = document.getElementById('startButton');
    const clearButton = document.getElementById('clearButton');
    const outputDiv = document.getElementById('output');
    const resultDiv = document.getElementById('result');
    const statusDiv = document.getElementById('status');
    const summaryList = document.getElementById('summaryList');
    
    // ç²å–å“é …åç¨±ä¸¦æŒ‰ç…§é•·åº¦å¾é•·åˆ°çŸ­æ’åº (é•·å“é …å„ªå…ˆ)
    const itemNames = Object.keys(menu).sort((a, b) => b.length - a.length);
    const itemPattern = itemNames.join('|');

    // åˆå§‹åŒ–é»æ“Šäº‹ä»¶
    document.querySelectorAll('.menu-button').forEach(button => {
        button.addEventListener('click', () => {
            const item = button.getAttribute('data-item');
            handleMenuClick(item);
        });
    });

    // æ¸…ç©ºæŒ‰éˆ•äº‹ä»¶
    clearButton.addEventListener('click', () => {
        currentOrder = {};
        outputDiv.textContent = 'è¾¨è­˜çµæœ: (è¨‚å–®å·²æ¸…ç©º)';
        updateDisplay('clear');
    });

    /**
     * è™•ç†èœå–®æŒ‰éˆ•é»æ“Šäº‹ä»¶
     * @param {string} item - å“é …åç¨±
     */
    function handleMenuClick(item) {
        currentOrder[item] = (currentOrder[item] || 0) + 1;
        updateDisplay('click');
    }

    /**
     * çµ±ä¸€æ›´æ–°é¡¯ç¤ºç•«é¢å’Œç¸½é‡‘é¡
     * @param {string} source - è§¸ç™¼æ›´æ–°çš„ä¾†æº ('voice', 'click', or 'clear')
     */
    function updateDisplay(source) {
        let total = 0;
        let speechItems = [];

        if (Object.keys(currentOrder).length === 0) {
            summaryList.innerHTML = '<li>ç„¡å“é …</li>';
            resultDiv.innerHTML = `ç¸½é‡‘é¡: $0`;
            if (source === 'voice') {
                 // èªéŸ³æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ²’æœ‰é»åˆ°æ±è¥¿ï¼Œä¸å”¸å‡ºçµæœ
                 return;
            }
        } else {
            let listHTML = '';
            
            for (const item of itemNames) {
                const quantity = currentOrder[item];
                if (quantity > 0) {
                    const itemCost = quantity * menu[item];
                    total += itemCost;
                    
                    listHTML += `<li>${item} x ${quantity} = $${itemCost}</li>`;
                    speechItems.push(`${item}${quantity}å€‹`);
                }
            }
            summaryList.innerHTML = listHTML;
            resultDiv.innerHTML = `ç¸½é‡‘é¡: $${total}`;
        }

        // èªéŸ³è¼¸å‡º (åªåœ¨èªéŸ³æ¨¡å¼ä¸‹å”¸å‡ºçµæœ)
        if (source === 'voice' && total > 0) {
            let speechOutput = 'æ‚¨çš„è¨‚å–®æ˜¯ï¼š' + speechItems.join('ï¼Œ') + `ã€‚ç¸½å…±æ˜¯ ${total} å…ƒã€‚`;
            const utterance = new SpeechSynthesisUtterance(speechOutput);
            utterance.lang = 'zh-TW';
            window.speechSynthesis.speak(utterance);
        }
    }


    // --- èªéŸ³è¾¨è­˜é‚è¼¯ (V5.4 éº¥å…‹é¢¨é‡‹æ”¾ä¿®æ­£ç‰ˆ) ---
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'zh-TW';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            statusDiv.textContent = 'æ­£åœ¨è½æ‚¨èªªè©±... è«‹èªªå‡ºè¨‚å–® (ä¾‹: ç‡’é¤…ä¸‰å€‹, ç‰›è‚‰é¤¡é¤…äº”å€‹)';
            startButton.disabled = true;
            startButton.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­...';
        };

        // éº¥å…‹é¢¨é‡‹æ”¾é—œéµé» 1: ç¢ºä¿çµæŸæ™‚èƒ½é‡‹æ”¾æŒ‰éˆ•ç‹€æ…‹
        recognition.onend = () => {
            // é›–ç„¶ onresult è£¡æœƒ stop()ï¼Œä½† onend é‚„æ˜¯æœƒè¢«è§¸ç™¼ï¼Œç”¨æ–¼æ¸…ç†ä»‹é¢
            statusDiv.textContent = 'èªéŸ³è¼¸å…¥çµæŸï¼Œæ­£åœ¨è¨ˆç®—ã€‚';
            startButton.disabled = false;
            startButton.textContent = 'ğŸ™ï¸ é–‹å§‹èªéŸ³è¼¸å…¥';
        };

        recognition.onresult = (event) => {
            // éº¥å…‹é¢¨é‡‹æ”¾é—œéµé» 2: å–å¾—çµæœå¾Œï¼Œç«‹å³å¼·åˆ¶åœæ­¢è¾¨è­˜ï¼Œé‡‹æ”¾ç¡¬é«”è³‡æº
            recognition.stop(); 
            
            if (event.results.length > 0 && event.results[0].length > 0) {
                const transcript = event.results[0][0].transcript;
                outputDiv.textContent = 'è¾¨è­˜çµæœ: ' + transcript;
                
                if (transcript && transcript.trim() !== '') {
                    currentOrder = {};
                    calculateAndParse(transcript);
                } else {
                    outputDiv.textContent = 'è¾¨è­˜çµæœ: (ç„¡æœ‰æ•ˆèªéŸ³è¼¸å…¥)';
                    updateDisplay('voice');
                }
            } else {
                outputDiv.textContent = 'è¾¨è­˜å¤±æ•—æˆ–æ²’æœ‰åµæ¸¬åˆ°æœ‰æ•ˆèªéŸ³ã€‚';
                updateDisplay('voice');
            }
        };

        recognition.onerror = (event) => {
            statusDiv.textContent = 'èªéŸ³è¾¨è­˜éŒ¯èª¤: ' + event.error + 'ã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚';
            startButton.disabled = false;
            startButton.textContent = 'ğŸ™ï¸ é–‹å§‹èªéŸ³è¼¸å…¥';
        };

        startButton.onclick = () => {
            try {
                recognition.start();
            } catch (e) {
                statusDiv.textContent = 'è«‹å…è¨±ç€è¦½å™¨ä½¿ç”¨éº¥å…‹é¢¨ã€‚éŒ¯èª¤: ' + e.message;
            }
        };

        /**
         * åŸ·è¡ŒèªéŸ³æ–‡æœ¬è§£æ (V5 Master Regex)
         * @param {string} orderText - èªéŸ³è¾¨è­˜çš„æ–‡æœ¬
         */
        function calculateAndParse(orderText) {
            
            // 1. æ•¸å­—å’Œé‡è©è™•ç† (V5ï¼šç§»é™¤æ‰€æœ‰é‡è©å’Œåˆ†éš”ç¬¦è™Ÿï¼Œè®“æ–‡æœ¬é€£çºŒ)
            let processedText = orderText
                .replace(/ä¸€/g, '1').replace(/äºŒ|å…©/g, '2').replace(/ä¸‰/g, '3')
                .replace(/å››/g, '4').replace(/äº”/g, '5').replace(/å…­/g, '6')
                .replace(/ä¸ƒ/g, '7').replace(/å…«/g, '8').replace(/ä¹/g, '9')
                .replace(/é›¶/g, '0')
                // ç§»é™¤æ‰€æœ‰é‡è©å’Œåˆ†éš”ç¬¦è™Ÿ
                .replace(/å€‹|ä»½|æ¯|ã€|ï¼Œ|,|ã€‚/g, ''); 

            // 2. V5 æ ¸å¿ƒé‚è¼¯ï¼šå–®ä¸€ Master Regex æƒæé€£çºŒæ–‡æœ¬
            const masterRegex = new RegExp(
                `(\\d*)(${itemPattern})(\\d*)`, 'gi'
            );

            // æš«æ™‚å„²å­˜èªéŸ³è§£æçš„çµæœ
            let voiceOrder = {};
            let match;
            
            // 3. éæ­·æ‰€æœ‰åŒ¹é…é …
            while ((match = masterRegex.exec(processedText)) !== null) {
                
                const item = match[2];
                let quantity = 0;

                // å„ªå…ˆä½¿ç”¨æ•¸å­—
                if (match[1] && match[3]) {
                     // å‰å¾Œéƒ½æœ‰æ•¸å­—ï¼Œå–å…©è€…ä¸­è¼ƒå¤§çš„ä¸€å€‹
                     quantity = Math.max(parseInt(match[1] || 0, 10), parseInt(match[3] || 0, 10));
                }
                else if (match[1]) { // æ•¸å­—åœ¨å“é …å‰ 
                    quantity = parseInt(match[1], 10);
                } else if (match[3]) { // æ•¸å­—åœ¨å“é …å¾Œ 
                    quantity = parseInt(match[3], 10);
                } else {
                    // æ²’æœ‰æ‰¾åˆ°æ•¸å­—ï¼Œå‡è¨­ç‚º 1
                    quantity = 1;
                }
                
                if (menu[item] && quantity > 0) {
                    // ä½¿ç”¨ Math.max ç¢ºä¿é•·å“é …æ•¸é‡ä¸æœƒè¢«çŸ­å“é …è¦†è“‹
                    voiceOrder[item] = Math.max((voiceOrder[item] || 0), quantity);
                }
            }
            
            // 4. æœ€çµ‚æ¸…ç†ï¼šç¢ºä¿é•·å“é …å„ªå…ˆ (ç§»é™¤è¢«é•·å“é …åŒ…å«çš„çŸ­å“é …)
            let cleanOrder = {};
            for (const item of itemNames) {
                 if (voiceOrder[item]) {
                      // æª¢æŸ¥æ˜¯å¦æœ‰æ›´é•·çš„å·²é»å“é …åŒ…å«äº†é€™å€‹çŸ­å“é …
                      let isCovered = itemNames.some(
                          longerItem => longerItem.length > item.length && 
                          longerItem.includes(item) && 
                          voiceOrder[longerItem] // ç¢ºä¿é•·å“é …åœ¨è¨‚å–®ä¸­
                      );

                      if (!isCovered) {
                          cleanOrder[item] = voiceOrder[item];
                      }
                 }
            }
            // å°‡ä¹¾æ·¨çš„èªéŸ³çµæœè¨­ç½®ç‚ºç•¶å‰è¨‚å–®
            currentOrder = cleanOrder;

            // 5. æ›´æ–°é¡¯ç¤º
            updateDisplay('voice');
        }
    } else {
        // ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³
        statusDiv.textContent = 'æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨/è¨­å‚™ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ (Web Speech API)ã€‚è«‹ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome æˆ– Safariã€‚';
        startButton.disabled = true;
    }
</script>
</body>
</html>
